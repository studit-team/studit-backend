<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.studit.domain.user.mapper.UserMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="UserInfoResultMap" type="com.studit.domain.user.dto.UserDTO">
        <id property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="phone" column="phone"/>
        <result property="userStatusCode" column="user_status_code"/>
        <result property="sbscrbBe" column="sbscrb_be"/>
        <result property="lgnAprvYn" column="lgn_aprv_yn"/>
        <result property="lgnFailNocs" column="lgn_fail_nocs"/>
        <result property="sctryDtrmnTrgetId" column="sctry_dtrmn_trget_id"/>
        <result property="authorCode" column="author_code"/>
        <result property="userTyCode" column="user_ty_code"/>
        <result property="name" column="name"/>
    </resultMap>

    <!-- 이메일로 사용자 조회 (권한 정보 포함) -->
    <select id="findByEmail" resultMap="UserInfoResultMap">
        SELECT
            ui.user_id,
            ui.name,
            ui.username,
            ui.password,
            ui.phone,
            ui.user_status_code,
            ui.sbscrb_be,
            ui.lgn_aprv_yn,
            ui.lgn_fail_nocs,
            ui.sctry_dtrmn_trget_id,
            us.author_code,
            us.user_ty_code
        FROM user_info ui
                 LEFT JOIN userscrtyestbs us ON ui.sctry_dtrmn_trget_id = us.sctry_dtrmn_trget_id
        WHERE ui.username = #{username}
    </select>

    <!-- 사용자 ID로 조회 -->
    <select id="findByUserId" resultMap="UserInfoResultMap">
        SELECT
            ui.user_id,
            ui.name,
            ui.username,
            ui.password,
            ui.phone,
            ui.user_status_code,
            ui.sbscrb_be,
            ui.lgn_aprv_yn,
            ui.lgn_fail_nocs,
            ui.sctry_dtrmn_trget_id,
            us.author_code,
            us.user_ty_code
        FROM user_info ui
                 LEFT JOIN userscrtyestbs us ON ui.sctry_dtrmn_trget_id = us.sctry_dtrmn_trget_id
        WHERE ui.username = #{userId}
    </select>

    <!-- 로그인 실패 횟수 증가 -->
    <update id="incrementLoginFailCount">
        UPDATE user_info
        SET lgn_fail_nocs = lgn_fail_nocs + 1
        WHERE user_id = #{userId}
    </update>

    <!-- 로그인 실패 횟수 초기화 -->
    <update id="resetLoginFailCount">
        UPDATE user_info
        SET lgn_fail_nocs = 0
        WHERE user_id = #{userId}
    </update>

    <!-- 로그인 이력 저장 -->
    <insert id="insertLoginHistory">
        INSERT INTO user_lgn_hstry (
            user_id,
            lgn_date,
            lgn_ip,
            lgn_sttus
        ) VALUES (
                     #{userId},
                     #{lgnDate},
                     #{lgnIp},
                     #{lgnSttus}
                 )
    </insert>

    <!-- 보안 설정 삽입 -->
    <insert id="insertUserScrtyEstbs">
        INSERT INTO userscrtyestbs (
            sctry_dtrmn_trget_id,
            user_ty_code,
            author_code
        ) VALUES (
                     #{securityId},
                     #{userTyCode},
                     #{authorCode}
                 )
    </insert>

    <!-- 사용자 정보 삽입 -->
    <insert id="insertUserInfo">
        INSERT INTO user_info (
            user_id,
            username,
            password,
            phone,
            user_status_code,
            sbscrb_be,
            lgn_aprv_yn,
            lgn_fail_nocs,
            sctry_dtrmn_trget_id,
            name
        ) VALUES (
                     #{userId},
                     #{username},
                     #{password},
                     #{phone},
                     #{userStatusCode},
                     #{sbscrbBe},
                     #{lgnAprvYn},
                     #{lgnFailNocs},
                     #{sctryDtrmnTrgetId},
                     #{name}
                 )
    </insert>

    <!-- 보안 설정 ID 개수 조회 (prefix로 시작하는) -->
    <select id="countSecurityIdByPrefix" resultType="int">
        SELECT COUNT(*)
        FROM userscrtyestbs
        WHERE sctry_dtrmn_trget_id LIKE CONCAT(#{prefix}, '%')
    </select>

</mapper>