<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.studit.domain.study.mapper.StudyDetailMapper">

    <resultMap id="assignmentMap" type="com.studit.domain.study.dto.schedule.AssignmentRespDto">
        <id property="taskId" column="task_id"/>
        <result property="studyId" column="study_id"/>
        <result property="title" column="title"/>
        <result property="dueDate" column="due_date"/>
        <result property="createdAt" column="created_at"/>
        <result property="maxMbrNocs" column="max_mbr_nocs"/>

        <collection property="submissions" ofType="com.studit.domain.study.dto.schedule.SubmissionDto">
            <result property="userId" column="user_id"/>
            <result property="submittedAt" column="submitted_at"/>
            <result property="status" column="status"/>
        </collection>
    </resultMap>

    <select id="getStudyHomeInfo" resultType="com.studit.domain.study.dto.study.StudyHomeRespDto">
        SELECT
            s.study_id,
            s.study_nm,
            s.study_dc,
            s.max_mbr_nocs,
            (SELECT COUNT(*) FROM study_mbr sm
             WHERE sm.study_id = s.study_id AND sm.mbr_status_code = 'APPROVED') as current_mbr_count,
            (SELECT string_agg(day_id, ',') FROM study_day_mapping sdm
             WHERE sdm.study_id = s.study_id) as regular_days,
            (SELECT string_agg(cc.category_nm, ',')
             FROM study_category_mapping scm
             JOIN category_code cc ON scm.category_id = cc.category_id
             WHERE scm.study_id = s.study_id) as category_names,
            (SELECT string_agg(cc.category_nm, ',')
             FROM study_category_mapping scm
                      JOIN category_code cc ON scm.category_id = cc.category_id
             WHERE scm.study_id = s.study_id) as category_names,
            (SELECT
                 CASE
                 WHEN r.sgg_nm LIKE r.sd_nm || '%' THEN r.sgg_nm
                 ELSE r.sd_nm || ' ' || r.sgg_nm
                 END
             FROM region r
             WHERE r.mpng_sn = s.mpng_sn) as region,
        (SELECT
            CASE
            WHEN EXISTS (SELECT 1 FROM study_mbr sm WHERE sm.study_id = s.study_id AND sm.user_id = #{userId}) THEN
            (SELECT CASE WHEN sm2.role_code = 'ROLE_LEADER' THEN 'LEADER' ELSE 'MEMBER' END
            FROM study_mbr sm2 WHERE sm2.study_id = s.study_id AND sm2.user_id = #{userId})
            WHEN EXISTS (SELECT 1 FROM applications ap WHERE ap.study_id = s.study_id AND ap.user_id = #{userId} AND ap.status = 'WAIT') THEN 'WAIT'
            ELSE 'NONE'
            END) as user_status
        FROM study s
        WHERE s.study_id = #{studyId}
    </select>

    <select id="getWeeklySchedules" resultType="com.studit.domain.study.dto.schedule.ScheduleRespDto">
        SELECT
            schedule_id as scheduleId,
            title,
            description,
            meeting_at as meetingAt,
            location,
            status
        FROM study_schedule
        WHERE study_id = #{studyId}
          AND meeting_at >= CURRENT_DATE - CAST(EXTRACT(DOW FROM CURRENT_DATE) AS INT)
          AND meeting_at &lt; CURRENT_DATE - CAST(EXTRACT(DOW FROM CURRENT_DATE) AS INT) + 7
        ORDER BY meeting_at
    </select>

    <select id="getRecentNotices" resultType="com.studit.domain.study.dto.post.PostListRespDto">
        SELECT
            board_id as boardId,
            user_id as userId,
            title,
            board_ty_cd as boardTyCd
        FROM board
        WHERE study_id = #{studyId}
          AND board_ty_cd = 'NOTICE'
        ORDER BY boardId
        LIMIT 2
    </select>
    <select id="getStudyNotices" resultType="com.studit.domain.study.dto.post.PostDetailRespDto">
        SELECT
            board_id as boardId,
            ui.user_id as userId,
            ui.username,
            title,
            content,
            file_url as fileUrl,
            board_ty_cd as boardTyCd
        FROM board
        left join public.user_info ui on ui.user_id = board.user_id
        WHERE study_id = #{studyId}
          AND board_ty_cd = 'NOTICE'
        ORDER BY boardId
    </select>

    <select id="getStudySchedules" resultType="com.studit.domain.study.dto.schedule.ScheduleRespDto">
        SELECT
            schedule_id as scheduleId,
            title,
            description,
            meeting_at as meetingAt,
            location,
            status
        FROM study_schedule
        WHERE study_id = #{studyId}
        ORDER BY meeting_at desc
    </select>

    <select id="getStudyTasks" resultMap="assignmentMap">
        SELECT
            t.task_id,
            t.study_id,
            t.title,
            t.due_date,
            t.created_at,
            (SELECT max_mbr_nocs FROM study sm
             WHERE sm.study_id = t.study_id) as max_mbr_nocs,
            ts.user_id,
            ts.submitted_at,
            ts.status
        FROM tasks t
                 LEFT OUTER JOIN task_submissions ts ON t.task_id = ts.task_id
        WHERE t.study_id = #{studyId}
        ORDER BY t.task_id
    </select>

    <select id="getStudyFreeBoardList" resultType="com.studit.domain.study.dto.post.PostListRespDto">
        SELECT
            board_id as boardId,
            user_id as userId,
            title,
            board_ty_cd as boardTyCd,
            (SELECT username FROM user_info ui
             WHERE ui.user_id = b.user_id) as username
        FROM board b
        WHERE study_id = #{studyId}
          AND board_ty_cd = 'FREE'
        ORDER BY boardId
    </select>

    <insert id="insertStudy" parameterType="com.studit.domain.study.dto.study.StudyCreateDto"
            useGeneratedKeys="true" keyProperty="studyId">
        insert into study (leader_id, study_nm, study_dc, mpng_sn, max_mbr_nocs, study_status_code)
        values (#{leaderId}, #{studyNm}, #{studyDc}, #{mpngSn}, #{maxMbrNocs}, #{studyStatusCode})
    </insert>

    <insert id="insertStudyCategory">
        insert into study_category_mapping (study_id, category_id)
        values
        <foreach collection="categoryIds" item="categoryId" separator=",">
            (#{studyId}, #{categoryId})
        </foreach>
    </insert>

    <insert id="insertStudyDayOfWeeks">
        insert into study_day_mapping (study_id, day_id)
        values
        <foreach collection="dayIds" item="dayId" separator=",">
            (#{studyId}, #{dayId})
        </foreach>
    </insert>

    <insert id="insertStudyMember">
        insert into study_mbr (study_id, user_id, role_code, mbr_status_code, join_date)
        values (#{studyId}, #{leaderId}, 'ROLE_LEADER', 'APPROVED', now())
    </insert>

    <insert id="insertStudyFee">
        INSERT INTO fee_mgmt (study_id,user_id,amount,fee_ty_code,pay_yn)
        VALUES
        <foreach collection="fees" item="fee" separator=",">
            (#{studyId},#{leaderId},#{fee.amount},#{fee.feeTyCode},'Y')
        </foreach>
    </insert>

    <insert id="applicationStudy">
        insert into applications (study_id, user_id, content, status, applied_at)
        VALUES (#{studyId}, #{userId}, #{content}, 'WAIT', now());
    </insert>

    <select id="checkAlreadyApplied" resultType="int">
        SELECT COUNT(*)
        FROM applications
        WHERE study_id = #{studyId}
          AND user_id = #{userId}
          AND status IN ('WAIT', 'APPROVED')
    </select>
</mapper>